{% extends 'base.html' %}
{% load staticfiles %}
{% block title %}数据中心{% endblock %}
{% block css %}
    <link rel="stylesheet" href="{% static 'css/index.css' %}">
{% endblock %}

{% block content %}
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document" style="width: 100%">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h2 class="modal-title" id="myModalLabel">Modal title</h2>
                </div>
                <div class="modal-body" style="height: 500px">
                    <div id="table" class="table-responsive" style="height: 100%"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <ul id="plotType" class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active">
                <a href="#raw" role="tab" data-toggle="tab" aria-expanded="true">
                    Raw Data
                </a>
            </li>
            <li role="presentation">
                <a href="#upload" role="tab" data-toggle="tab" aria-expanded="true">
                    Uploaded Data
                </a>
            </li>
        </ul>
        <div id="tabContent" class="tab-content">
            <div id="raw" role="tabpanel" class="tab-pane fade active in">
                <br>
                <form class="form-horizontal">
                    {% csrf_token %}
                    <div class="form-group">
                        <label class="col-lg-1 control-label">Title</label>
                        <div class="col-lg-3">
                            <input class="form-control" name="title">
                        </div>
                        <label class="col-lg-2 control-label">Raw color</label>
                        <div class="col-lg-2">
                            <input type="color" class="form-control" name="raw_color">
                        </div>
                        <label class="col-lg-2 control-label">Predict color</label>
                        <div class="col-lg-2">
                            <input type="color" class="form-control" name="predict_color">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-2 control-label">Features 1</label>
                        <div class="col-lg-2">
                            <select name="feature_1" class="form-control"></select>
                        </div>
                        <label class="col-lg-2 control-label">Features 2</label>
                        <div class="col-lg-2">
                            <select name="feature_2" class="form-control"></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-1 control-label"></label>
                        <div class="col-lg-4">
                            <button class="btn btn-default" type="button" onclick="showImage(this.parentNode.parentNode.parentNode, 'raw')">Plot</button>
                            <button class="btn btn-danger" type="reset" value="reset">Reset</button>
                        </div>
                    </div>
                </form>
            </div>
            <div id="upload" role="tabpanel" class="tab-pane fade">
                <br>
                <div class="alert alert-info" role="alert"></div>
                <form class="form-horizontal">
                    {% csrf_token %}
                    <div class="form-group">
                        <label class="col-lg-1 control-label">Test file</label>
                        <div class="col-lg-3">
                            <input class="form-control" name="uploadFile" type="file" onchange="uploadNewFile(this)">
                        </div>
                        <div class="col-lg-1">
                            <button type="button" class="btn btn-success" data-toggle="modal" data-target="#myModal">
                                Preview
                            </button>
                        </div>
                        <div class="col-lg-2">
                            <div class="progress" style="display: none">
                                <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                                    <span>Processing</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                <form class="form-horizontal">
                    {% csrf_token %}
                    <div class="form-group">
                        <label class="col-lg-2 control-label">
                            Columns for plotting
                            <br>
                            <br>
                            <button class="btn btn-upload" type="button" onclick="selectAll()">
                                <span class="glyphicon glyphicon-plus"></span>
                            </button>
                        </label>
                        <div id="plotColumns" class="col-lg-10" style="overflow: scroll;
                         overflow-x: hidden;
                         height: 80px;
                         border: 1px solid #ddd;
                         border-radius: 5px 5px 5px 5px;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-1 control-label">Title</label>
                        <div class="col-lg-3">
                            <input class="form-control" name="title">
                        </div>
                        <label class="col-lg-2 control-label">Raw color</label>
                        <div class="col-lg-2">
                            <input type="color" class="form-control" name="raw_color">
                        </div>
                        <label class="col-lg-2 control-label">Predict color</label>
                        <div class="col-lg-2">
                            <input type="color" class="form-control" name="predict_color">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-2 control-label">Features 1</label>
                        <div class="col-lg-2">
                            <select name="feature_1" class="form-control"></select>
                        </div>
                        <label class="col-lg-2 control-label">Features 2</label>
                        <div class="col-lg-2">
                            <select name="feature_2" class="form-control"></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-1 control-label"></label>
                        <div class="col-lg-4">
                            <button class="btn btn-default" type="button" onclick="showImage(this.parentNode.parentNode.parentNode, 'upload')">Plot</button>
                            <button class="btn btn-danger" type="reset" value="reset" onclick="clean()">Reset</button>
                        </div>
                    </div>
                </form>
                <form class="form-horizontal">
                    <div class="form-group">
                        <label class="col-lg-3 control-label">Rename</label>
                        <input type="hidden" name="featurizer" value="rename">
                        <div class="col-lg-2">
                            <select name="targetColumn" class="form-control"></select>
                        </div>
                        <div class="col-lg-2">
                            <input name="value" class="form-control">
                        </div>
                        <div class="col-lg-1">
                            <button class="btn btn-success" type="button" onclick="featurize(this.parentNode.parentNode.parentNode)">
                                <span class="glyphicon glyphicon-play"></span>
                            </button>
                        </div>
                        <div class="col-lg-2">
                            <div class="progress" style="display: none">
                                <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                                    <span>Processing</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                <form class="form-horizontal">
                    <div class="form-group">
                        <label class="col-lg-3 control-label">Convert string to structure</label>
                        <input type="hidden" name="featurizer" value="strToStructure">
                        <div class="col-lg-2">
                            <select name="targetColumn" class="form-control"></select>
                        </div>
                        <div class="col-lg-1">
                            <button class="btn btn-success" type="button" onclick="featurize(this.parentNode.parentNode.parentNode)">
                                <span class="glyphicon glyphicon-play"></span>
                            </button>
                        </div>
                        <div class="col-lg-2">
                            <div class="progress" style="display: none">
                                <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                                    <span>Processing</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                <form class="form-horizontal">
                    <div class="form-group">
                        <label class="col-lg-3 control-label">Convert string to composition</label>
                        <input type="hidden" name="featurizer" value="strToComposition">
                        <div class="col-lg-2">
                            <select name="targetColumn" class="form-control"></select>
                        </div>
                        <div class="col-lg-1">
                            <button class="btn btn-success" type="button" onclick="featurize(this.parentNode.parentNode.parentNode)">
                                <span class="glyphicon glyphicon-play"></span>
                            </button>
                        </div>
                        <div class="col-lg-2">
                            <div class="progress" style="display: none">
                                <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                                    <span>Processing</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                <form class="form-horizontal">
                    <div class="form-group">
                        <label class="col-lg-3 control-label">Convert structure to composition</label>
                        <input type="hidden" name="featurizer" value="structureToComposition">
                        <div class="col-lg-2">
                            <select name="targetColumn" class="form-control"></select>
                        </div>
                        <div class="col-lg-1">
                            <button class="btn btn-success" type="button" onclick="featurize(this.parentNode.parentNode.parentNode)">
                                <span class="glyphicon glyphicon-play"></span>
                            </button>
                        </div>
                        <div class="col-lg-2">
                            <div class="progress" style="display: none">
                                <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                                    <span>Processing</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                <form class="form-horizontal">
                    <div class="form-group">
                        <label class="col-lg-3 control-label">Featurize structure</label>
                        <div class="col-lg-2">
                            <select name="targetColumn" class="form-control"></select>
                        </div>
                        <div class="col-lg-2">
                            <select name="featurizer" class="form-control"></select>
                        </div>
                        <div class="col-lg-1">
                            <button class="btn btn-success" type="button" onclick="featurize(this.parentNode.parentNode.parentNode)">
                                <span class="glyphicon glyphicon-play"></span>
                            </button>
                        </div>
                        <div class="col-lg-2">
                            <div class="progress" style="display: none">
                                <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                                    <span>Processing</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                <form class="form-horizontal">
                    <div class="form-group">
                        <label class="col-lg-3 control-label">Featurize composition</label>
                        <div class="col-lg-2">
                            <select name="targetColumn" class="form-control"></select>
                        </div>
                        <div class="col-lg-2">
                            <select name="featurizer" class="form-control"></select>
                        </div>
                        <div class="col-lg-1">
                            <button class="btn btn-success" type="button" onclick="featurize(this.parentNode.parentNode.parentNode)">
                                <span class="glyphicon glyphicon-play"></span>
                            </button>
                        </div>
                        <div class="col-lg-2">
                            <div class="progress" style="display: none">
                                <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                                    <span>Processing</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <br>
        <div class="container">
            <iframe id="fitImage" style="width: 100%; height: 800px"></iframe>
        </div>
        <br>
        <div class="row col-lg-offset-1">
            <a id="downloadPredict" class="btn btn-success" style="display: none" href="#">Download predict file</a>
        </div>
    </div> <!-- /container -->
    <script src="{% static 'js/jquery-3.3.1.min.js' %}"></script>
    <script src="{% static 'js/preprocess.js' %}"></script>
    <script>
    var rawLabel;
    var jobId = {{ jobId }};
    var feature_1 = [];
    var feature_2 = [];

    $(document).ready(function () {
        $('#plotType a').click(function (e) {
            e.preventDefault();
            $(this).tab('show')
        });
        $.ajax({
            url: "/detail/columns?model_id=" + jobId,
            type: "GET",
            success: function (retVal) {
                let label = retVal["label"];
                if (label == "") {
                    alert("You job is currently not available.")
                }
                else {
                    label.splice(label.length - 1);
                    rawLabel = label;
                    $(".alert-info").html("Your raw data contains features: " + label.join(", ") + ". " +
                        "Please make sure the uploaded data's features for calculating match them!");
                    createFeatureList(label, 'raw')
                }
            }
        });
        let selector = $("#upload").find("select[name='featurizer']");
        $(selector[0]).html(structureFeaturizersSelector());
        $(selector[1]).html(compositionFeaturizersSelector())
    });

    // Get the shape of upload file
    function uploadNewFile(ele){
        let progress = $(ele).parent().siblings().find(".progress");
        progress.removeAttr("style");
        let file = ele.files[0];
        let formData = new FormData();
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        formData.append('uploadFile', file);
        $.ajax({
            url: "/detail/preprocess/",
            type: "POST",
            data: formData,
            contentType: false,
            processData: false,
            success: function (retVal) {
                let label = retVal["label"];
                if (label != ""){
                    createFeatureList(label, 'upload');
                    $("#table").html(retVal["html"]);
                    $("table").addClass("table table-striped table-bordered text-nowrap");
                }
                progress.attr("style", "display: none")
            }
        })
    }

    // Calculate new chemical features
    function featurize(ele) {
        let progress = $(ele).find(".progress");
        progress.removeAttr("style");
        let option = $(ele).serializeArray();
        if (option["targetColumn"] == '0'){
            return 0
        }
        let optList = "?";
        for (let i = 0; i < option.length; i++){
            optList += option[i]["name"];
            optList += "=" + option[i]["value"] + "&"
        }
        optList = optList.slice(0, optList.length - 1);
        $.ajax({
                url: "/detail/preprocess/" + optList,
                type: "GET",
                success: function (retVal) {
                    if (typeof (retVal["error"]) != "undefined" ) {
                        console.log(retVal["error"])
                    }
                    else {
                        let html = retVal['html'];
                        $("#table").html(html);
                        $("table").addClass("table table-striped table-bordered text-nowrap");
                        createFeatureList(retVal["label"], "upload")
                    }
                    feature_1 = [];
                    feature_2 = [];
                    refreshPlotFeature();
                    progress.attr("style", "display: none")
                },
                error:function (msg) {
                    progress.attr("style", "display: none");
                    console.log(msg)
                }
            });
    }

    // Create features list according to the shape of test set
    function createFeatureList(label, chooseData) {
        let html_str = "<option value='0'>None</option>";
        for (let i = 1; i <= label.length; i++){
            let str = '<option value=' + label[i - 1] + '>' + label[i - 1] + '</option>';
            html_str += str
        }
        let selector = $("#" + chooseData);
        if (chooseData == "upload"){
            let checkBox = "";
            for (let i = 0; i < label.length; i++) {
                checkBox += '<div class="checkbox col-lg-2"><label><input name="' + label[i] +
                    '" type="checkbox" onchange="addPlotFeatures(this)">' + label[i] +
                    '</label></div>'
            }
            selector.find("select[name='targetColumn']").html(html_str);
            $("#plotColumns").html(checkBox)
        }
        else {
            selector.find("select[name='feature_1']").html(html_str);
            selector.find("select[name='feature_2']").html(html_str);
        }
    }

    // Draw the graph
    function showImage(ele, chooseData) {
        let form = $(ele).serializeArray();
        let formData = new FormData();
        $.each(form, function (i, field) {
            formData.append(field["name"], field["value"])
        });
        formData.append("id", jobId);
        formData.append("chooseData", chooseData);
        $.ajax({
            url: "/draw/",
            type: "POST",
            data: formData,
            dataType:"JSON",
            contentType: false,
            processData: false,
            success: function (retVal) {
                if (retVal["err"] != ""){
                    alert(retVal["err"])
                }
                else {
                    let fig = document.getElementById("fitImage").contentDocument;
                    fig.open();
                    fig.write(retVal["image"]);
                    fig.close();
                    let href = "/download/";
                    let downloadBtn = $("#downloadPredict");
                    downloadBtn.attr("href", href);
                    downloadBtn.removeAttr("style");
                }
            },
            error: function (msg) {
                console.log(msg)
            }
        })
    }

    // Select all checkbox
    function selectAll() {
        $("#plotColumns").find("input").click()
    }

    // Add features choices for plotting
    function addPlotFeatures(ele) {
        let plotColumn = ele.name;
        let index = feature_1.indexOf(plotColumn);
        if (index == -1){
            feature_1.push(plotColumn);
            feature_2.push(plotColumn)
        }
        else {
            feature_1.splice(index, 1);
            feature_2.splice(index, 1)
        }
        refreshPlotFeature()
    }

    // Refresh features choice
    function refreshPlotFeature() {
        let html_str = "<option value='0'>None</option>";
        for (let i = 1; i <= feature_1.length; i++){
            let str = '<option value=' + feature_1[i - 1] + '>' + feature_1[i - 1] + '</option>';
            html_str += str
        }
        $("#upload").find("select[name='feature_1']").html(html_str);
        $("#upload").find("select[name='feature_2']").html(html_str);
    }

    // Clean the features array
    function clean() {
        feature_1 = [];
        feature_2 = [];
        refreshPlotFeature();
    }
    </script>
{% endblock %}